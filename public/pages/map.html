<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>CHATRA Mapï¼šæ—¥æœ¬é™å®šï¼‹ãƒ”ãƒ³â†’ãƒ«ãƒ¼ãƒ ä½œæˆãƒ•ã‚©ãƒ¼ãƒ </title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>

  <!-- CSS ã¯ã‚ãªãŸã®æŒ‡å®šã®å ´æ‰€ -->
  <link rel="stylesheet" href="/assets/css/pages/map.css" />
</head>
<body>
  <div id="map"></div>

  <!-- å³ä¸Šãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ -->
  <button class="hamburger" id="menuBtn" aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼">
    <span class="hamburger-lines"><span></span><span></span><span></span></span>
  </button>

  <!-- å³ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ«ï¼ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼‰ -->
  <aside class="side-panel" id="sidePanel">
    <div class="side-header">
      <div class="side-title">CHATRA ãƒ¡ãƒ‹ãƒ¥ãƒ¼</div>
      <button class="side-close" id="sideCloseBtn">âœ•</button>
    </div>

    <nav class="side-nav">
      <button class="side-item" data-view="search">ğŸ” ãƒ«ãƒ¼ãƒ æ¤œç´¢</button>
      <button class="side-item" data-view="list">ğŸ“‹ ãƒ«ãƒ¼ãƒ ä¸€è¦§</button>
      <!-- <button class="side-item" data-view="list2">ğŸ“— å±¥æ­´</button> -->
      <button class="side-item" id = "mypageButton" data-view="mypage">ğŸ“— mypage</button>
    </nav>

    <div class="side-content">
      <!-- æ¤œç´¢ãƒ“ãƒ¥ãƒ¼ -->
      <div class="panel-view" id="view-search">
        <label class="side-label" for="searchInput">ãƒ«ãƒ¼ãƒ åã§æ¤œç´¢</label>
        <input id="searchInput" type="text" class="side-input" placeholder="ä¾‹ï¼šæ±äº¬ / æœ­å¹Œ / æ¸©æ³‰ / å‹é”å‹Ÿé›†" />
        <button id="searchBtn" class="side-search-btn">æ¤œç´¢</button>
        <!-- <div id="searchResult" class="side-result muted">æ¤œç´¢çµæœã¯ã“ã“ã«å‡ºã¾ã™ï¼ˆä»Šã¯ãƒ€ãƒŸãƒ¼ï¼‰</div> -->
        <!-- âœ… ê²€ìƒ‰ ê²°ê³¼ê°€ í‘œì‹œë  ë¦¬ìŠ¤íŠ¸ -->
        <ul id="searchResultList" class="room-list">
          <li class="muted">æ¤œç´¢ã—ã¦ãã ã•ã„ã€‚</li>
        </ul>
      </div>

      <!-- ä¸€è¦§ãƒ“ãƒ¥ãƒ¼ -->
      <div class="panel-view" id="view-list" style="display:none;">
        <div class="muted" style="margin-bottom:8px;">ãƒ«ãƒ¼ãƒ ã‚’é¸æŠã™ã‚‹ã¨ãƒãƒ£ãƒƒãƒˆç”»é¢ã«åˆ‡ã‚Šæ›¿ã‚ã‚Šã¾ã™ã€‚</div>
        <ul class="room-list" id="roomList"></ul>
      </div>

       <!-- ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ å±¥æ­´ -->
       <div class="panel-view" id="view-list2" style="display:none;">
        <div class="muted" style="margin-bottom:8px;">ãƒ«ãƒ¼ãƒ ã‚’é¸æŠã™ã‚‹ã¨ãƒãƒ£ãƒƒãƒˆç”»é¢ã«åˆ‡ã‚Šæ›¿ã‚ã‚Šã¾ã™ã€‚</div>
        <ul class="room-list" id="roomList2"></ul>
      </div>


      <!-- ãƒãƒ£ãƒƒãƒˆãƒ“ãƒ¥ãƒ¼ -->
      <div class="panel-view" id="view-chat" style="display:none;">
        <div class="chat-header">
          <div class="chat-room-name" id="chatRoomName">ãƒ«ãƒ¼ãƒ å</div>
          <button class="chat-back" id="chatBackBtn">â† ä¸€è¦§ã¸</button>
        </div>
        <div class="chat-body" id="chatBody">
          <div class="chat-msg chat-msg-other">ã„ã‚‰ã£ã—ã‚ƒã„ï¼ã“ã“ã§è¦³å…‰æƒ…å ±å…±æœ‰ã—ã¦ã­</div>
          <div class="chat-msg chat-msg-me">äº†è§£ã§ã™ï¼</div>
        </div>
        <form class="chat-input-area" id="chatForm">
          <input type="text" id="chatInput" class="chat-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." autocomplete="off" />
          <button type="submit" class="chat-send">é€ä¿¡</button>
        </form>
      </div>
    </div>
  </aside>

  <!-- ãƒ«ãƒ¼ãƒ ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal-backdrop" id="modalBackdrop"></div>
  <div class="modal" id="roomModal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ã‚’ä½œæˆ</div>
        <button class="icon-btn" id="closeModal" aria-label="é–‰ã˜ã‚‹">âœ•</button>
      </div>

      <form id="roomForm" class="form-grid">
        <input type="hidden" id="roomLng" name="lng" />
        <input type="hidden" id="roomLat" name="lat" />

        <div class="row">
          <label for="roomName">ãƒ«ãƒ¼ãƒ å <span class="muted">ï¼ˆå¿…é ˆï¼‰</span></label>
          <input type="text" id="roomName" name="name" placeholder="ä¾‹ï¼šä¸é‚£å›½å³¶ å¤•æ—¥ã‚¹ãƒãƒƒãƒˆ" required />
        </div>

        <div class="row">
          <label for="roomDesc">æ¦‚è¦</label>
          <textarea id="roomDesc" name="description" placeholder="ã©ã‚“ãªãƒ«ãƒ¼ãƒ ã‹ã€ç°¡å˜ã«èª¬æ˜ã—ã¦ãã ã•ã„ã€‚"></textarea>
        </div>

        <div class="row">
          <div class="row-inline">
            <input type="checkbox" id="roomPublic" name="isPublic" checked />
            <label for="roomPublic" style="margin:0;">ãƒãƒ£ãƒƒãƒˆã‚’å…¬é–‹ã™ã‚‹</label>
          </div>
          <div class="muted">â€»éå…¬é–‹ã«ã™ã‚‹ã¨ã€å‚åŠ ã«ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™ã€‚</div>
        </div>

        <div class="row" id="pwRow" style="display:none;">
          <label for="roomPassword">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ <span class="muted">ï¼ˆéå…¬é–‹æ™‚ã¯å¿…é ˆï¼‰</span></label>
          <input type="password" id="roomPassword" name="password" placeholder="8æ–‡å­—ä»¥ä¸Šæ¨å¥¨" />
        </div>

        <div class="form-row" style="margin-top: 20px;">
          <label style="display:block; margin-bottom:10px; font-weight:bold;">
              æ‹›å¾…ç¯„å›² (åŠå¾„): <span id="radiusValue" style="color:#007bff; font-size:1.2rem;">10</span> km
          </label>
          <input type="range" id="roomRadius" min="1" max="100" value="10" step="1" style="width:100%;">
          <div style="display: flex; justify-content: space-between; color: #888; font-size: 0.8rem;">
              <span>1km</span>
              <span>100km</span>
          </div>
        </div>

        <div class="actions">
          <button type="button" class="btn btn-secondary" id="cancelBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button type="submit" class="btn btn-primary" id="submitBtn">ä½œæˆã™ã‚‹</button>
        </div>
      </form>
    </div>
  </div>

  <!-- âœ… JS ã¯å¤–å‡ºã— -->
    <script src="/socket.io/socket.io.js"></script>
    <script src="/assets/js/map.js"></script>
    <script src="/assets/js/mypage.js"></script>

    <script>
    const socket = io();
    const roomId = window.location.pathname.split('/').pop(); // URLì—ì„œ roomId ì¶”ì¶œ
    // const roomId = `room_${new Date().getTime()}`; // ã“ã®å‡¦ç†ã¯ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ã‚’ä½œã‚‹æ™‚ã«è¡Œã„ã¾ã™ã€‚


    socket.emit('join room', roomId); // ì„œë²„ì— ì±„íŒ…ë°© ì°¸ì—¬ ì´ë²¤íŠ¸ ì „ì†¡


    // const inviteForm = document.getElementById('invite-form');
    // const inviteEmailInput = document.getElementById('invite-email');

    // inviteForm.addEventListener('submit', function(e) {
    //     e.preventDefault();
    //     const emailToInvite = inviteEmailInput.value;

    //     if (emailToInvite) {
    //             // ì„œë²„ë¡œ 'invite user' ì´ë²¤íŠ¸ë¥¼ ë³´ëƒ…ë‹ˆë‹¤.
    //             // ì´ˆëŒ€í•  ì´ë©”ì¼ê³¼ í˜„ì¬ ë°© IDë¥¼ í•¨ê»˜ ì „ì†¡í•©ë‹ˆë‹¤.
    //         socket.emit('invite user', {
    //                 recipientEmail: emailToInvite,
    //                 roomId: roomId
    //         });
    //             inviteEmailInput.value = '';
    //         }
    //     });



    const form = document.getElementById('chatForm');
    const input = document.getElementById('chatInput');

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        if (input.value) {
        socket.emit('chat message', {
            roomId: roomId,
            message: input.value
        });
        input.value = '';
        }
    });

    // socket.on('chat message', function(msg) {
    //     const item = document.createElement('li');
    //     item.textContent = `${msg.sender}: ${msg.message}`;
    //     document.getElementById('messages').appendChild(item);
    //     window.scrollTo(0, document.body.scrollHeight);
    // });
    </script>
</body>
</html>